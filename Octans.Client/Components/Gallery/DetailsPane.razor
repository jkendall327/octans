@using Octans.Core.Models
@using Octans.Core.Notes
@using Octans.Core.Tags
@using Octans.Client.Components.Gallery
@inject INoteService NoteService
@inject ITagService TagService
@inject ISnackbar Snackbar

@if (SelectedHash is not null)
{
    <div class="details-pane">
        <section class="file-info">
            <MudText Typo="Typo.h6">File Details</MudText>
            <MudText Typo="Typo.body2">Hash: @SelectedHash</MudText>
            @* Add more file info here if available *@
        </section>

        <section class="tags-section">
             <TagViewer Tags="@Tags" />
        </section>

        <section class="notes-section">
            <MudText Typo="Typo.h6">Notes</MudText>
            <MudList T="Note" Dense="true">
                @foreach (var note in Notes)
                {
                    <MudListItem>
                        <MudCard Outlined="true" Class="pa-2 mb-2">
                             <MudCardContent>
                                 <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@note.Content</MudText>
                                 <MudText Typo="Typo.caption" Color="Color.Secondary">@note.CreatedAt.ToLocalTime()</MudText>
                             </MudCardContent>
                             <MudCardActions>
                                 <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(() => DeleteNote(note))" Color="Color.Error" />
                             </MudCardActions>
                        </MudCard>
                    </MudListItem>
                }
            </MudList>

            <MudTextField @bind-Value="NewNoteContent" Label="Add a note" Variant="Variant.Outlined" Lines="3" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNote" Disabled="@string.IsNullOrWhiteSpace(NewNoteContent)" Class="mt-2">Add Note</MudButton>
        </section>
    </div>
}
else
{
    <div class="empty-state">
        <MudText Typo="Typo.body1">Select an image to view details.</MudText>
    </div>
}

@code {
    [Parameter]
    public string? SelectedHash { get; set; }

    private List<Note> Notes { get; set; } = new();
    private List<TagViewer.Tag> Tags { get; set; } = new();
    private string NewNoteContent { get; set; } = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (SelectedHash is not null)
        {
            Notes = await NoteService.GetNotesAsync(SelectedHash);
            var tagModels = await TagService.GetTagsForHashAsync(SelectedHash);
            Tags = tagModels.Select(t => new TagViewer.Tag(t.Namespace, t.Subtag, 0)).ToList();
        }
        else
        {
            Notes.Clear();
            Tags.Clear();
        }
    }

    private async Task AddNote()
    {
        if (SelectedHash is not null && !string.IsNullOrWhiteSpace(NewNoteContent))
        {
            try
            {
                var note = await NoteService.AddNoteAsync(SelectedHash, NewNoteContent);
                Notes.Add(note);
                NewNoteContent = string.Empty;
                Snackbar.Add("Note added", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to add note: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteNote(Note note)
    {
        try
        {
            await NoteService.DeleteNoteAsync(note.Id);
            Notes.Remove(note);
            Snackbar.Add("Note deleted", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete note: {ex.Message}", Severity.Error);
        }
    }
}

<style>
    .details-pane {
        padding: 10px;
        overflow-y: auto;
        height: 100%;
    }

    .file-info {
        margin-bottom: 20px;
    }

    .notes-section {
        display: flex;
        flex-direction: column;
    }

    .empty-state {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #888;
    }
</style>
